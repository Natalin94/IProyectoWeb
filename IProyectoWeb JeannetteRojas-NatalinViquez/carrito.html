<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Products</title>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
	<script src="js/materialize.min.js" ></script>
	<script src="js/main.js" ></script>
	
</head>
<body>

	<style type="text/css">
		h5{
			text-align: center;
			font-family: Arial;
		}

	</style>

	<nav class="NavBar full">
		<div class="row">
			<div class="tittles NavBar-logo col s12 m3">Zapateria Online..</div>
			<ul class="NavBar-links col m9">
				<li><a href="index.html" class="waves-effect">Home</a></li>
				
			</ul>
			<i class="zmdi zmdi-more-vert full btn-menu hide-on-med-and-up waves-effect"></i>
		</div>
	</nav>
	<div class="full ShoppingCart valign-wrapper">
		<div class="container valign">
			<div class="row valign-wrapper">
				<div class="col s12 m6 valign">
					<p class="center-align" style="color: #2F9FF3;">
						<i class="zmdi zmdi-shopping-cart zmdi-hc-5x"></i>		
					</p>
					<p class="center-align">
						<a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-tooltip="Empty cart" style="margin-right: 17px;"><i class="zmdi zmdi-delete"></i></a>
						<a class="btn-floating waves-effect waves-light green tooltipped" data-position="bottom" data-tooltip="Confirm purchase"><i class="zmdi zmdi-money"></i></a>
					</p>
				</div>
			</div>
		</div>
	</div>

		<section>
			<h5>Mi carrito</h5>
		<div class="container">
			<div class="row">

			<script type="text/javascript">
			 var persona = function(id, nombre, apellidos, edad, email, direccion, telefono, contraseña, numeroTarjeta, codigoSeguridad, fechaVencimiento, tipo, productosAdquiridos, dineroInvertido){
			      this.id = id;
			      this.nombre= nombre;
			      this.apellidos= apellidos;
			      this.edad= edad;
			      this.email= email;
			      this.direccion= direccion;
			      this.telefono= telefono;
			      this.contraseña = contraseña;
			      this.numeroTarjeta= numeroTarjeta;
			      this.codigoSeguridad= codigoSeguridad;
			      this.fechaVencimiento= fechaVencimiento;
			      this.tipo = tipo;
			      this.productosAdquiridos= productosAdquiridos;
			      this.dineroInvertido= dineroInvertido;
			  }
			

			arregloZ = localStorage.getItem("listaCarro");
			arregloZ = JSON.parse(arregloZ);

			arregloProductos = localStorage.getItem("productos");
			arregloProductos = JSON.parse(arregloProductos);		
			
			$(document).ready(function(){ 
			debugger; 
		        $(document).ready(function(){   
		        
	       		for(var i=0, l=arregloZ.length; i < l; i++) {
	       			debugger;

	       			if(arregloZ[i].id == sessionStorage.getItem("username")){
	       				
	       				for (var j=0, n=arregloProductos.length; j < n; j++){
	       					if(arregloProductos[j].idP == arregloZ[i].idZap){
	       						addElement(arregloProductos[j].imagen, arregloProductos[j].idP)
		       					debugger;	
	       					}		
	       				}
	       			}	        								
	        	} 
		       	

		        function addElement (url, elemento) { 
				  // crea un nuevo div 
				  // y añade contenido 
				  var newDiv = document.createElement("div"); 
				  var x = document.createElement("IMG");
    			  //x.setAttribute("src", "images/zap2.jpg");
    			  x.setAttribute("src", url);
    			  x.setAttribute("width", "250");
    			  x.setAttribute("height", "270");
    			  
    			  var butListaDeseos = document.createElement("INPUT");
    			  var butCarrito = document.createElement("INPUT");

    			  butListaDeseos.setAttribute("type", "button");
    			  butListaDeseos.setAttribute("value", "Eliminar");
    			  butListaDeseos.setAttribute("class", "eliminarElemento");
    			  butListaDeseos.setAttribute("id",elemento);


    			  butCarrito.setAttribute("type", "button");    			 
    			  butCarrito.setAttribute("value", "Comprar");
    			  butCarrito.setAttribute("class", "comprarB");
    			  butCarrito.setAttribute("id",elemento);


				  // añade el elemento creado y su contenido al DOM 
				  var currentDiv = document.getElementById("div1"); 
				  document.getElementById("myHeader").appendChild(newDiv);
				  document.getElementById("myHeader").appendChild(x);
				  document.getElementById("myHeader").appendChild(butListaDeseos);
				  document.getElementById("myHeader").appendChild(butCarrito);
				  //document.body.insertBefore(newDiv, currentDiv); 
				}   

				// ENLACE CON EL BOTON DE COMPRAR UN PRODUCTO
				$(".comprarB").click(function(){
					botID= this.id;
					myFunction(botID);
						
				});
				// FUNCION DE COMPRAR UN PRODUCTO
				function myFunction(idBoton) {
				    //var txt;
				    var person = prompt("Indique el codigo de seguridad de su tarjeta:", "");
				    
				    if (person != null || person != "") {
				       // txt = "User cancelled the prompt.";
				       var codigoSeguridadVar= person;

				    } 
				    var fechaVencimiento = prompt("Fecha de vencimiento", "mm/aa");
				     if (fechaVencimiento != null || fechaVencimiento != "") {
				       // txt = "User cancelled the prompt.";
				       var fechaDeVencimiento= fechaVencimiento;

				    } 

				    for (var j=0, n=localStorage.length; j < n; j++){
				    	debugger;
				    	
				    	var temporalPrecio= 0;
				    	
				    	key = localStorage.key(j);
				    	user= sessionStorage.getItem("idUsuario");
	       				if(key == sessionStorage.getItem("idUsuario")){
	       						debugger;
	       						personaGuardada = localStorage.getItem(key);
            					personaGuardada = JSON.parse(personaGuardada);
	       						if(personaGuardada.codigoSeguridad == codigoSeguridadVar && personaGuardada.fechaVencimiento == fechaDeVencimiento){
	       							alert("Perfecto");

	       							for (var j=0, n=arregloProductos.length; j < n; j++){
				       					if(arregloProductos[j].idP == idBoton){
				       						debugger;
				       							temporalPrecio= arregloProductos[j].precio;
				       					}		
				       				}
				       				
	       							nuevoPAdquiridos= personaGuardada.productosAdquiridos+=1;
	       							nuevoCantDinero = personaGuardada.dineroInvertido += temporalPrecio;

	       							var nuevaPersona =  new persona(personaGuardada.id, personaGuardada.nombre , personaGuardada.apellidos, personaGuardada.edad, personaGuardada.email, personaGuardada.direccion, personaGuardada.telefono, personaGuardada.contraseña, personaGuardada.numTarjeta, personaGuardada.codigoSeguridad,personaGuardada.fechaVencimiento, true, nuevoPAdquiridos, nuevoCantDinero);
	       							localStorage.setItem(user, JSON.stringify(nuevaPersona));
	       							invocarAlHistorial(idBoton);
	       						}
	       					}		
	       				}		       		   
				}

				// FUNCION PREVIA PARA AGREGAR AL HISTORIAL
				// DE AQUI SE LLAMA A LA DE AGREGAR AL HISTORIAL
				function invocarAlHistorial(idBoton) {
					historial = localStorage.getItem("listaHistorial")
					alert("entra al invocar", idBoton);
					if (historial == null){
						array=[];
						localStorage.setItem("listaHistorial",array);
						agregarAlHistorial(true, idBoton);
					}
					else{
						
						agregarAlHistorial(false, idBoton);
					}	
			    } 	

			    //PARA AGREGAR AL HISTORIAL DEL CLIENTE
			    function agregarAlHistorial(indicador, idBoton) {
					if (indicador == true){
						arregloHistorial = localStorage.getItem("listaHistorial")
					}

					if (indicador == false){
						arregloHistorial = localStorage.getItem("listaHistorial")
						arregloHistorial = JSON.parse(arregloHistorial);
					}
				
					array=[]
					for(var i=0, l=arregloHistorial.length; i < l; i++) {						
						array.push(arregloHistorial[i]);						
		        	} 
		        	debugger;
		        	var historial = {
						id : sessionStorage.username,
						idZap : idBoton
					};	
		        	prueba= JSON.stringify(historial);
					array.push(historial);
					localStorage.setItem("listaHistorial",JSON.stringify(array));
					alert("Producto agregado satisfactoriamente!!");

			    } 	

				// FUNCION PARA ELIMINAR UN PRODUCTO DEL CARRITO
				$(".eliminarElemento").click(function(){
					lisCarro = localStorage.getItem("listaCarro")
					lisCarro= JSON.parse(lisCarro);
					array=[];
					
					botID= this.id;
				

					for (var j=0, n=lisCarro.length; j < n; j++){
	       					if(lisCarro[j].idZap == botID && lisCarro[j].id == sessionStorage.getItem("username") ){
	       						lisCarro.splice(j, 1);
	       						alert(lisCarro[j]);	
								localStorage.setItem("listaCarro",JSON.stringify(lisCarro));
								window.location= "carrito.html";
	       						break;
	       				}		
	       			}								
				});

		    });		

		 });    

			</script>
			</div>
		</div>
		</section>

		<section id="myHeader">
		<div id="demo" class="container">
			<div class="row">
			

			</div>
	 </div>
</section>

	<footer class="footer">
		<div class="container">
			<div class="row">
				<div class="col s12 m6">
					<h5>Información</h5>
								<ul class="links">
									<li><a href="#">Metodos de pago</a></li>
									<li><a href="#">Codigo de compra</a></li>
									<li><a href="#">Logistica de la empresa</a></li>
				</div>
				<div class="col s12 m6">
					<h5 class="center-align">Contactanos</h5>
					<ul class="center-align">
						<li><a href="#!"><i class="zmdi zmdi-facebook"></i> &nbsp; Facebook</a></li>
						<li><a href="#!"><i class="zmdi zmdi-twitter"></i> &nbsp; Twitter</a></li>
						<li><a href="#!"><i class="zmdi zmdi-google-plus"></i> &nbsp; Google+</a></li>
						<li><a href="#!"><i class="zmdi zmdi-instagram"></i> &nbsp; Instagram</a></li>
					</ul>	
				</div>
				<div class="col s12 tittles footer-copyright">zap &copy; 2016</div>
			</div>
		</div>
	</footer>
</body>
</html>